#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ðŸ”„ SYSTEM AUTOMATION SETUP - MINT-LIKE CONVENIENCE              â•‘
# â•‘  Automated maintenance, updates, and system monitoring           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Symbols
CHECK="âœ…"
CROSS="âŒ"
WARNING="âš ï¸"
INFO="â„¹ï¸"
ARROW="âžœ"
ROCKET="ðŸš€"

echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘  ðŸ”„ SYSTEM AUTOMATION SETUP                                      â•‘${NC}"
echo -e "${CYAN}â•‘  Setting up Mint-like automated maintenance and monitoring       â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“‹ SYSTEM UPDATE AUTOMATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BLUE}ðŸ“‹ SYSTEM UPDATE AUTOMATION${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Create automated system update script
cat > /home/craig/.local/bin/auto-system-update << 'EOF'
#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ðŸ”„ AUTOMATED SYSTEM UPDATE SCRIPT                               â•‘
# â•‘  Comprehensive system maintenance with safety checks             â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOG_FILE="/var/log/auto-system-update.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# Function to log messages
log_message() {
    echo "[$DATE] $1" | sudo tee -a "$LOG_FILE"
}

# Function to send notification
send_notification() {
    if command -v notify-send >/dev/null 2>&1; then
        notify-send "System Update" "$1" --icon=software-update-available
    fi
}

log_message "Starting automated system update"
send_notification "System update started"

# Pre-update snapshot
log_message "Creating pre-update snapshot"
if sudo timeshift --create --description "Pre-update snapshot $DATE" >/dev/null 2>&1; then
    log_message "Pre-update snapshot created successfully"
else
    log_message "WARNING: Failed to create pre-update snapshot"
fi

# Update package databases
log_message "Updating package databases"
if yay -Sy >/dev/null 2>&1; then
    log_message "Package databases updated successfully"
else
    log_message "ERROR: Failed to update package databases"
    send_notification "System update failed: Database update error"
    exit 1
fi

# Check for updates
UPDATES=$(yay -Qu | wc -l)
log_message "Found $UPDATES package updates"

if [ "$UPDATES" -eq 0 ]; then
    log_message "No updates available"
    send_notification "System is up to date"
    exit 0
fi

# Perform system update
log_message "Installing $UPDATES package updates"
if yay -Su --noconfirm >/dev/null 2>&1; then
    log_message "System update completed successfully"
    send_notification "System updated successfully ($UPDATES packages)"
else
    log_message "ERROR: System update failed"
    send_notification "System update failed"
    exit 1
fi

# Clean package cache
log_message "Cleaning package cache"
yay -Sc --noconfirm >/dev/null 2>&1
yay -Yc --noconfirm >/dev/null 2>&1

# Apply dotfiles
log_message "Applying dotfiles configuration"
if chezmoi apply >/dev/null 2>&1; then
    log_message "Dotfiles applied successfully"
else
    log_message "WARNING: Failed to apply dotfiles"
fi

# Post-update snapshot
log_message "Creating post-update snapshot"
if sudo timeshift --create --description "Post-update snapshot $DATE" >/dev/null 2>&1; then
    log_message "Post-update snapshot created successfully"
else
    log_message "WARNING: Failed to create post-update snapshot"
fi

log_message "Automated system update completed"
send_notification "System update completed successfully"
EOF

chmod +x /home/craig/.local/bin/auto-system-update
echo -e "${CHECK} Created automated system update script"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“¸ SNAPSHOT MANAGEMENT AUTOMATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo
echo -e "${PURPLE}ðŸ“¸ SNAPSHOT MANAGEMENT AUTOMATION${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Create snapshot cleanup script
cat > /home/craig/.local/bin/auto-snapshot-cleanup << 'EOF'
#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ðŸ“¸ AUTOMATED SNAPSHOT CLEANUP                                   â•‘
# â•‘  Intelligent snapshot management with retention policies         â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOG_FILE="/var/log/auto-snapshot-cleanup.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

log_message() {
    echo "[$DATE] $1" | sudo tee -a "$LOG_FILE"
}

log_message "Starting snapshot cleanup"

# Retention policy:
# - Keep all snapshots from last 7 days
# - Keep weekly snapshots for last month
# - Keep monthly snapshots for last 6 months
# - Remove everything older

# Delete snapshots older than 6 months (except monthly ones)
SNAPSHOTS_TO_DELETE=$(sudo timeshift --list | grep -E "^\s*>" | awk '{print $2}' | while read snapshot; do
    SNAPSHOT_DATE=$(echo "$snapshot" | sed 's/.*_\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}\).*/\1/')
    if [ -n "$SNAPSHOT_DATE" ]; then
        SNAPSHOT_EPOCH=$(date -d "$SNAPSHOT_DATE" +%s 2>/dev/null)
        SIX_MONTHS_AGO=$(date -d "6 months ago" +%s)
        
        if [ "$SNAPSHOT_EPOCH" -lt "$SIX_MONTHS_AGO" ]; then
            # Check if it's a monthly snapshot (1st of month)
            SNAPSHOT_DAY=$(echo "$SNAPSHOT_DATE" | cut -d'-' -f3)
            if [ "$SNAPSHOT_DAY" != "01" ]; then
                echo "$snapshot"
            fi
        fi
    fi
done)

if [ -n "$SNAPSHOTS_TO_DELETE" ]; then
    echo "$SNAPSHOTS_TO_DELETE" | while read snapshot; do
        log_message "Deleting old snapshot: $snapshot"
        sudo timeshift --delete --snapshot "$snapshot" >/dev/null 2>&1
    done
else
    log_message "No old snapshots to delete"
fi

# Create weekly snapshot if needed
LAST_WEEKLY=$(sudo timeshift --list | grep "Weekly" | tail -1 | awk '{print $2}')
if [ -n "$LAST_WEEKLY" ]; then
    LAST_WEEKLY_DATE=$(echo "$LAST_WEEKLY" | sed 's/.*_\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}\).*/\1/')
    LAST_WEEKLY_EPOCH=$(date -d "$LAST_WEEKLY_DATE" +%s 2>/dev/null)
    WEEK_AGO=$(date -d "1 week ago" +%s)
    
    if [ "$LAST_WEEKLY_EPOCH" -lt "$WEEK_AGO" ]; then
        log_message "Creating weekly snapshot"
        sudo timeshift --create --description "Weekly snapshot $DATE" >/dev/null 2>&1
    fi
else
    log_message "Creating first weekly snapshot"
    sudo timeshift --create --description "Weekly snapshot $DATE" >/dev/null 2>&1
fi

log_message "Snapshot cleanup completed"
EOF

chmod +x /home/craig/.local/bin/auto-snapshot-cleanup
echo -e "${CHECK} Created automated snapshot cleanup script"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ—‚ï¸ SYSTEM MAINTENANCE AUTOMATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo
echo -e "${GREEN}ðŸ—‚ï¸ SYSTEM MAINTENANCE AUTOMATION${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Create system maintenance script
cat > /home/craig/.local/bin/auto-system-maintenance << 'EOF'
#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ðŸ—‚ï¸ AUTOMATED SYSTEM MAINTENANCE                                  â•‘
# â•‘  Comprehensive system cleanup and optimization                   â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LOG_FILE="/var/log/auto-system-maintenance.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

log_message() {
    echo "[$DATE] $1" | sudo tee -a "$LOG_FILE"
}

log_message "Starting system maintenance"

# Clean package cache
log_message "Cleaning package cache"
CACHE_SIZE_BEFORE=$(du -sh /var/cache/pacman/pkg/ 2>/dev/null | cut -f1)
yay -Sc --noconfirm >/dev/null 2>&1
yay -Yc --noconfirm >/dev/null 2>&1
CACHE_SIZE_AFTER=$(du -sh /var/cache/pacman/pkg/ 2>/dev/null | cut -f1)
log_message "Package cache: $CACHE_SIZE_BEFORE -> $CACHE_SIZE_AFTER"

# Remove orphaned packages
log_message "Removing orphaned packages"
ORPHANS=$(pacman -Qtdq 2>/dev/null | wc -l)
if [ "$ORPHANS" -gt 0 ]; then
    pacman -Qtdq | sudo pacman -Rns - --noconfirm >/dev/null 2>&1
    log_message "Removed $ORPHANS orphaned packages"
else
    log_message "No orphaned packages found"
fi

# Clean temporary files
log_message "Cleaning temporary files"
TEMP_SIZE_BEFORE=$(du -sh /tmp 2>/dev/null | cut -f1)
sudo find /tmp -type f -atime +7 -delete 2>/dev/null
sudo find /tmp -type d -empty -delete 2>/dev/null
TEMP_SIZE_AFTER=$(du -sh /tmp 2>/dev/null | cut -f1)
log_message "Temporary files: $TEMP_SIZE_BEFORE -> $TEMP_SIZE_AFTER"

# Clean user cache
log_message "Cleaning user cache"
USER_CACHE_BEFORE=$(du -sh /home/craig/.cache 2>/dev/null | cut -f1)
find /home/craig/.cache -type f -atime +30 -delete 2>/dev/null
find /home/craig/.cache -type d -empty -delete 2>/dev/null
USER_CACHE_AFTER=$(du -sh /home/craig/.cache 2>/dev/null | cut -f1)
log_message "User cache: $USER_CACHE_BEFORE -> $USER_CACHE_AFTER"

# Update locate database
log_message "Updating locate database"
if command -v updatedb >/dev/null 2>&1; then
    sudo updatedb >/dev/null 2>&1
    log_message "Locate database updated"
fi

# Update man pages database
log_message "Updating man pages database"
if command -v mandb >/dev/null 2>&1; then
    sudo mandb >/dev/null 2>&1
    log_message "Man pages database updated"
fi

log_message "System maintenance completed"
EOF

chmod +x /home/craig/.local/bin/auto-system-maintenance
echo -e "${CHECK} Created automated system maintenance script"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â° SYSTEMD TIMER SETUP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo
echo -e "${YELLOW}â° SYSTEMD TIMER SETUP${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Create systemd service for system updates
sudo tee /etc/systemd/system/auto-system-update.service >/dev/null << EOF
[Unit]
Description=Automated System Update
After=network.target

[Service]
Type=oneshot
User=craig
ExecStart=/home/craig/.local/bin/auto-system-update
EOF

# Create systemd timer for system updates
sudo tee /etc/systemd/system/auto-system-update.timer >/dev/null << EOF
[Unit]
Description=Run Automated System Update Daily
Requires=auto-system-update.service

[Timer]
OnCalendar=daily
Persistent=true
RandomizedDelaySec=3600

[Install]
WantedBy=timers.target
EOF

# Create systemd service for system maintenance
sudo tee /etc/systemd/system/auto-system-maintenance.service >/dev/null << EOF
[Unit]
Description=Automated System Maintenance
After=network.target

[Service]
Type=oneshot
User=root
ExecStart=/home/craig/.local/bin/auto-system-maintenance
EOF

# Create systemd timer for system maintenance
sudo tee /etc/systemd/system/auto-system-maintenance.timer >/dev/null << EOF
[Unit]
Description=Run Automated System Maintenance Weekly
Requires=auto-system-maintenance.service

[Timer]
OnCalendar=weekly
Persistent=true
RandomizedDelaySec=1800

[Install]
WantedBy=timers.target
EOF

# Create systemd service for snapshot cleanup
sudo tee /etc/systemd/system/auto-snapshot-cleanup.service >/dev/null << EOF
[Unit]
Description=Automated Snapshot Cleanup
After=network.target

[Service]
Type=oneshot
User=root
ExecStart=/home/craig/.local/bin/auto-snapshot-cleanup
EOF

# Create systemd timer for snapshot cleanup
sudo tee /etc/systemd/system/auto-snapshot-cleanup.timer >/dev/null << EOF
[Unit]
Description=Run Automated Snapshot Cleanup Weekly
Requires=auto-snapshot-cleanup.service

[Timer]
OnCalendar=weekly
Persistent=true
RandomizedDelaySec=3600

[Install]
WantedBy=timers.target
EOF

echo -e "${CHECK} Created systemd services and timers"

# Enable and start timers
echo
echo -e "${ROCKET} Enabling automated services..."
sudo systemctl daemon-reload
sudo systemctl enable auto-system-update.timer
sudo systemctl enable auto-system-maintenance.timer
sudo systemctl enable auto-snapshot-cleanup.timer
sudo systemctl start auto-system-update.timer
sudo systemctl start auto-system-maintenance.timer
sudo systemctl start auto-snapshot-cleanup.timer

echo -e "${CHECK} All automation timers enabled and started"

echo
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘  ${ROCKET} AUTOMATION SETUP COMPLETE!                                 â•‘${NC}"
echo -e "${CYAN}â•‘                                                                   â•‘${NC}"
echo -e "${CYAN}â•‘  â€¢ Daily system updates with snapshots                           â•‘${NC}"
echo -e "${CYAN}â•‘  â€¢ Weekly system maintenance and cleanup                         â•‘${NC}"
echo -e "${CYAN}â•‘  â€¢ Automated snapshot management                                 â•‘${NC}"
echo -e "${CYAN}â•‘                                                                   â•‘${NC}"
echo -e "${CYAN}â•‘  Check status: systemctl list-timers                             â•‘${NC}"
echo -e "${CYAN}â•‘  View logs: journalctl -u auto-system-update.service             â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"